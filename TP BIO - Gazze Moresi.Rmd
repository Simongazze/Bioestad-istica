---
title: "TP - Validación de datos"
author: "Gazze Simón - Moresi Manuel"
date: "2025-04-15"
output: html_document
---

## Introducción

En el marco de un estudio de investigación clínica multicéntrico, se ha recolectado información a través de un formulario dirigido a mujeres mayores de 18 años con el objetivo de implementar estándares internacionales para el crecimiento fetal. Estos estándares permitirán facilitar la detección temprana de alteraciones en el desarrollo del feto durante la gestación.

Dado que la calidad de los datos es fundamental para garantizar la validez de los resultados en estudios clínicos, en este trabajo nos enfocamos en la validación de la base de datos proveniente del formulario. Nuestra tarea como equipo de análisis estadístico consiste en detectar, clasificar y documentar los errores presentes en los datos recolectados. Esto incluye inconsistencias internas, valores imposibles o improbables, datos faltantes, duplicados, y cualquier otro tipo de anomalía que pueda comprometer la calidad del estudio.

El formulario contiene las siguientes preguntas:

![Formulario](images/formulario_page-0001.jpg)

## Objetivo

Llevar a cabo un proceso exhaustivo de validación, empleando técnicas para evaluar la calidad de los datos ingresados y detectar errores sistemáticos en el llenado de los formularios.

## Desarrollo

### 1) Reglas de validación

Las reglas de validación que se plantearan para detectar inconsistencias son las siguientes:

-   La fecha de inscripción debe seguir el siguiente formato: dd(del 1 al 31)/mm(del 1 al 12)/yyyy(menor a 2025) (*Date of interview*).

-   El ID del paciente debe seguir el siguiente formato: dd/mm/yyyy-AA (es decir, *Birth Date + Initials*).

-   Las mujeres deben ser mayores de 18 años (18 years *\< Date of interview - Birth Date \<* 100 years).

-   Los códigos de paises posibles en este estudio son: 4, 11, 14, 23, 31, 48, 54, 65, 72, 97 (*Country code =* 4, 11, 14, 23, 31, 48, 54, 65, 72, 97).

-   Los grupos étnicos deben ser iguales a 1="Caucasico",2="Asiatico",3="Africano" o 4="Otro"(*Ethnic group =* 1, 2, 3, 4).

-   Las preguntas mencionadas en el formulario como 1, 2 y 3 deben ser iguales a 1="No" o 2="Si".

-   Si las 3 preguntas anteriores son iguales a 2="Si", entonces la pregunta *Subject Number* debe contener respuesta, en caso contrario debe dejarse en blanco (**2 condiciones**).

-   La respuesta de *Subject Number* debe seguir el siguiente formato: <u>0</u> \_ \_ (*country code*)\_ \_ (*physician code = numeric*) \_ \_ \_ (*subject code = numeric*).

-   Adicionalmente, se contaran las celdas que esten vacias en cada variable.

Y el código para detectar estos errores es el siguiente:

```{r,echo=FALSE, message=FALSE}
library(readxl)
library(tidyverse)

adm <- read_excel("adm.xlsx")
```

```{r}
reglas = tribble(
~id, ~descrip, ~cond,
"r1", "(countrycode) es faltante", "is.na(countrycode)",
"r2", "(patientid) es faltante", "is.na(patientid)",
"r3", "(interview) es faltante", "is.na(interview)",
"r4", "(ethnicgroup) es faltante", "is.na(ethnicgroup)",
"r5", "(scr) es faltante", "is.na(scr)",
"r6", "(usscr) es faltante", "is.na(usscr)",
"r7", "(consent) es faltante", "is.na(consent)",
"r8", "(ethnicgroup) distinto de 1,2,3 o 4", "!ethnicgroup %in% c(1, 2, 3, 4)",
"r9", "(scr) distinto de 1 o 2", "!scr %in% c(1,2)",
"r10", "(usscr) distinto de 1 o 2", "!usscr %in% c(1,2)",
"r11", "(consent) distinto de 1 o 2", "!consent %in% c(1,2)",
"r12", "(countrycode) distinto de 4, 11, 14, 23, 31, 48, 54, 65, 72 o 97", "!countrycode %in% c(4, 11, 14, 23, 31, 48, 54, 65, 72, 97)",
"r13", "(interview) no sigue formato dd/mm/yyyy", "!tryCatch(!is.na(as.Date(`interview`, format='%d/%m/%Y')), error = function(e) TRUE)",
"r14", "Edad fuera de rango según Patient ID y Date of interview", "{
    fecha_nac <- as.Date(sub('-.*', '', `patientid`), format='%d/%m/%Y')
    fecha_entrevista <- as.Date(`interview`, format='%d/%m/%Y')
    edad <- as.numeric(difftime(fecha_entrevista, fecha_nac, units='days')) / 365.25
    edad < 18 | edad > 100
  }",
"r15", "subjectnumber tiene valor cuando scr, usscr o consent no son 2", "(scr != 2 | usscr != 2 | consent != 2) & !is.na(subjectnumber) & subjectnumber != ''",
"r16", "subjectnumber está vacío cuando scr, usscr y consent son 2", "(scr == 2 & usscr == 2 & consent == 2) & (is.na(subjectnumber) | subjectnumber == '')",
"r17", "subjectnumber no respeta formato: 3 dígitos de countrycode + 6 números", 
"(scr == 2 & usscr == 2 & consent == 2) & 
  (!grepl('^\\\\d{9}$', subjectnumber) | substr(subjectnumber, 1, 3) != sprintf('%03d', countrycode))"
)

#falta ver si patientid cumple el formato
```

### 2) Detección de errores

A través de las reglas anteriormente mencionadas se van a identificar los errores presentes en la base de datos "***adm"***. Dicha base cuenta con la información referida a 1000 encuestas realizadas.

```{r}

validador = function(regla, id, cond){
reglas = regla[[cond]]
names(reglas) = regla[[id]]
reglas
}


validar = function(datos, id, validador){
sapply(
validador,
function(x) eval(parse(text = x), datos)
) |>
dplyr::as_tibble() |>
dplyr::mutate(registro = datos[[id]], .before = 0)
}
```

```{r}
validacion = validar(adm, "patientid", validador(reglas, "id", "cond"))
inconsistencias = sum(validacion[,2:18],na.rm = T)
validacion
```

Las celdas con TRUE corresponden a errores en esa regla de validación. Además, en registro se especifica a que encuestada pertenece.Obteniendo un total de inconsistencias de `r inconsistencias`

### 3) Informe de errores

a)  Número de participantes limpios (sin inconsistencias)

```{r}
validacion_largo = pivot_longer(validacion, -registro, names_to = "regla", values_to = "error")
head(validacion_largo)

ind_incos = validacion_largo |>
filter(error) |>
distinct(registro) |>
count()

1000 - ind_incos
```

761 de las participantes no presentan errores en la carga de sus datos.

b)  Participantes con inconsistencias

```{r}
ind_incos
```

Por consecuencia, 239 de las entrevistadas presentan al menos un error en la carga de sus respuestas.

c)  Inconsistencias más frecuentes

```{r}
colSums(validacion[,2:18],na.rm = T)
#Hacer gráfico de barras
```
d) Campos con más errores

```{r}
preg_a =sum(validacion[,c(2,13)],na.rm = T)
preg_b =sum(validacion[,c(3,15)],na.rm = T)
preg_c =sum(validacion[,c(4,14)],na.rm = T)



#como contemplar en el caso de que sea menor de edad o sea una señora de 120 años, cual de los #campos es el del error?birth date?date of interview?



```

